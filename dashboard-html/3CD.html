<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i,900,900i" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css?family=Gugi" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="css/style.css" />
<link rel="stylesheet" type="text/css" href="css/responsive.css" />
<title>Love moving | Dashboard </title>
<style>
    #loading-img {
    background: url(http://preloaders.net/preloaders/360/Velocity.gif) center center no-repeat;
    height: 100%;
    z-index: 20;
}

.overlay {
    background: #e9e9e9;
    display: none;
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    opacity: 0.5;
}

.show-result {
  margin: 10px;
  padding: 10px;
  color: green;
  font-size: 20px;
}

.star-rating s:hover,
.star-rating s.active {
    color:yellow;
}
.star-rating-rtl s:hover,
.star-rating-rtl s.active {
    color: yellow;
}

.star-rating s,
.star-rating-rtl s {
    color: black;
    font-size: 50px;
    cursor: default;
    text-decoration: none;
    line-height: 50px;
}
.star-rating {
    padding: 2px;
}
.star-rating-rtl {
    background: #555;
    display: inline-block;
    border: 2px solid #444;
}
.star-rating-rtl s {
    color: yellow;
}
.star-rating s:hover:before,
.star-rating s.rated:before,
.star-rating s.active:before {
    content: "\2605";
}
.star-rating s:before {
    content: "\2606";
}
.star-rating-rtl s:hover:after,
.star-rating-rtl s.rated:after,
.star-rating-rtl s.active:after {
    content: "\2605";
}

.star-rating-rtl s:after {
    content: "\2606";
}

</style>
</head>
<body>


<div class="whitehdr">
  <div class="wrap tbpadding">
  	  	 <h1 class="logowrap"><a href="https://lovemoving.herokuapp.com"><img src="images/logo.png" alt="logo"></a></h1>	
         <div class="topbar-rgt">
         	 <div class="profile-area">
         		<a href="#"><span id="username"></span><img src="images/pic-1.jpg" alt="pic-1"></a>
             </div>
             <div class="icons">
             	<a href="0chat.html"><img src="images/icon-chat.png" alt="chat"></a>
             </div>
             <div class="icons">
             	<a href="#"><img src="images/icon-bell.png" alt="bell"></a>
             </div>
             <div class="icons">
             	<a href="#"><img src="images/icon-setting.png" alt="setting"></a>
             </div>
             <div class="profile-area">
                <h4 id="logout" style="cursor: pointer;">Logout</h4>
            </div>
         </div>
   </div>
</div>



<div class="navwrap">
		<div class="wrap">
            <label for="show-menu" class="show-menu">Show Menu</label>
			<input type="checkbox" id="show-menu" role="button">
         	<ul id="menu">
                <li><a href="1CD.html">Overview </a></li>
                <li><a href="2CD.html">Profile </a></li>
                <li><a href="3CD.html" class="active">Bookings </a></li>
                <li><a href="4CD.html">Notifications </a></li>
                <li><a href="5CD.html">Financial </a></li>
                <li><a href="6CD.html">Settings </a></li>
            </ul>
         </div>
</div>



<div class="content-area">
    <div class="wrap content-wrap">
    	   <div class="whbox">
                    <div class="text-hd">
                        <h2><strong>Ongoing Work </strong></h2>
                    </div>
                    <div class="table-sc-wrap"> 
                        <div class="table-wrap three-cd-table">
                            <table id="ongoing_user_data">
                                <tr>
                                    <th width="30%">Date </th>
                                    <th>Service Type </th>
                                    <th >Location </th>
                                    <th>Job ID </th>
                                    <th>Action </th>
                                </tr>
                            </table>
                        </div>
                    </div>
           </div>
           
           <div class="whbox">
                    <div class="text-hd">
                        <h2><strong>Past Work History </strong></h2>
                    </div>
                    <div class="table-sc-wrap"> 
                        <div class="table-wrap three-cd-table">
                            <table id="user_data">
                                <tr>
                                    <th>Date </th>
                                    <th>Service Type </th>
                                    <th>Location </th>
                                    <th>Job ID </th>
                                    <th>Action </th>
                                </tr>
                            </table>
                            <img id="preloader" style="margin-left: 393px;" src="../images/preloader.gif" alt="logo">
                        </div>
                    </div>
           </div>
    </div>
</div>


<div class="footer-wrap"></div>


<div class="pop">
  <div class="content-area">
    <div class="wrap content-wrap">
    	<div class="whbox-wrap pos"><i class="icon-remove-sign"></i>
    	   <div class="whbox">
                    <div class="text-hd padding">
                        <h3>Job Overview <span id="jobId"> </span></h3>
                    </div>
                    <div class="table-sc-wrap"> 
                        <div class="table-wrap padding three-cd-one-table">
                            <table id="jobOverview">
                                <tr>
                                    <th>Date </th>
                                    <th>Service Type </th>
                                    <th>Location </th>
                                    <th>Hired by </th>
                                    <th>Job ID </th>
                                    <th>Action </th>
                                </tr>
                            </table>
                        </div>
                    </div>
           </div>
           <div class="graybox">
                    	 <div class="graydesc">
                                <div class="gbox-one">
                                    <h6>Job Description </h6>
                                    <!-- <p>Etiam et nibh bibendum, accumsan nulla sed, bibendum sem. Integer rhoncus sem turpis, id sodales turpis elementum eu. Aliquam et varius mi, sed feugiat lorem. Sed viverra magna. </p> -->
                                    <p id="JobDescription"></p>
                                </div>
                                <div class="gbox-two">
                                    <h6>Services </h6>
                                    <p class="blue-txt">Boxing, Packaging, Unboxing, Logistics, Trucks, Fragile Handling, Furniture Handling, Storage, Full Relocation Services, 24/7 Support </p>
                                </div>
                                <div class="gbox-three">
                                    <h6>From </h6>
                                    <p class="blue-txt" id="fromLocation"> </p>
                                    <br />
                                    <h6>To </h6>
                                    <p class="blue-txt" id="toLocation"> </p>
                                </div>
                                <div class="gbox-four">
                                    <h6>Hired by </h6>
                                    <p class="blue-txt">John W. Doe </p>
                                    <br />
                                    <h6>Price </h6>
                                    <p class="blue-txt">$ 2,800.00 </p>
                                </div>
                           </div>
                           <div class="tickwrap">
                                
                           		<div class="tickarea">
                                        <img id="status-preloader" style="margin-left: 393px;" align="center" src="../images/preloader.gif" alt="logo">
                                	<img style="visibility:hidden;" class="job_confirm" src="images/tick-active.png" alt="tick-active">
                                    <span style="visibility:hidden;" id="job_confirm" class="active job_confirm">Job Confirmed </span>
                                </div>
                           		<div class="tickarea">
                                	<img style="visibility:hidden;" class="on_the_way" src="images/tick-active.png" alt="tick-active">
                                    <span style="visibility:hidden;" id="on_the_way" class="active on_the_way">On our way to you </span>
                                </div>
                           		<div class="tickarea">
                                	<img style="visibility:hidden;" class="arrived" src="images/tick-active.png" alt="tick-active">
                                    <span style="visibility:hidden;" class="active arrived">Arrived & Working </span>
                                </div>
                           		<div class="tickarea">
                                	<img style="visibility:hidden;" class="relocation_progress" src="images/tick-active.png" alt="tick-active">
                                    <span style="visibility:hidden;" class="active relocation_progress">Relocation In Progress </span>
                                </div>
                           		<div class="tickarea">

                                	<img  style="visibility:hidden;" class="finished" src="images/tick-active.png" alt="tick-active">
                                    <span style="visibility:hidden;" class="active finished">Finished </span>
                                </div>
                           		<div class="tickarea">
                                	<img id="payment_feedback" src="images/tick.png" alt="tick">
                                    <span>Payment & Feedback </span>
                                </div>
                           </div>
                    </div>
                    <div class="padding newtoppd">
                         <div class="rating-area">
                             <h6 id="overall_rating" >Overall Rating </h6>
                           	 <!-- <div class="starwrap">
                                <div class="star-rating"><s><s><s><s><s></s></s></s></s></s></div> -->

                             	<!-- <a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                                <span>Professionalist </span> -->
                             <!-- </div> -->
                           	 <div class="starwrap">
                             	<!-- <a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                                <span>Commitment </span> -->
                             </div>
                           	 <div class="starwrap">
                             	<!-- <a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                                <span>Customer Care </span> -->
                             </div>
                           	 <div class="starwrap">
                             	<!-- <a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                             	<a href="#"><img src="images/icon-star.png" alt="star"></a>
                                <span>Delivery </span> -->
                             </div>
                         </div>
                         <div class="overlay">
                            <div id="loading-img"></div>
                        </div>
                         <div class="feedback-area">
                             
                             <h6>Share your experience with this Service Provider </h6>
                                <textarea name="feedback" rows="5"	col="5" value="" id="feedback_value" placeholder="Lorem ipsum"></textarea>
                             <input type="submit" name="submit" id="feedback" value="PROVIDE FEEDBACK" />
                         </div>
                         <br class="clear" /> 
                    </div>
        </div>
     </div>
  </div>
</div>



<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="js/common.js" type="text/javascript"></script>
<script src="../js/custom.js" type="text/javascript"></script>
<script src="../js/conf.js" type="text/javascript"></script>


<script type="text/javascript">


    $(document).ready(function () {
        
        var numStars = 0;
        var service_provider = 0
          , isFeedbackGiven = 0;
        // $(function() {
        //     $("div.star-rating > s").on("click", function(e) {
        //         $(this).closest('div').find('.active').removeClass('active');
        //         $(e.target).parentsUntil("div").addClass('active');
        //         $(e.target).addClass('active');
        //         numStars = $(e.target).parentsUntil("div").length+1;
        //     });
        // });
        $('#feedback').click(function(){
            //alert(numStars);
            var feedback = $('#feedback_value').val();
            var jobId = $('#jobId').text();
            var flag = true;
            //alert();
            if(isFeedbackGiven == 1){
                flag = false;
                alert("Feedback and rating has given already...");
                return;
            }
            if(feedback == '') {
                flag = false;
                $('#feedback_value').css('border-color','red');
            }
            else {
                $('#feedback_value').css('border-color','');
            }
            if(numStars == 0){
                flag = false;
                $('#overall_rating').css('color','red');
            }
            else {
                $('#overall_rating').css('color','');
            }

            //alert(service_provider);
            if(flag){
                $(".overlay").show();
                $("#feedback-area").attr('disabled','disabled');
                $.ajax({
                    url:API_URL + '/customer-feedback',
                    type:'POST',
                    data:{
                        feedback_note:feedback,
                        orderid:jobId.substr(1).trim(),
                        numStars:numStars,
                        service_provider:service_provider,
                        userId:localStorage.getItem('userId')
                    },
                    success:function(res){
                        $("#feedback-area").attr('disabled','');
                        $('#feedback_value').val('');
                        setTimeout(function(){
                            $(".overlay").hide();
                            $('#payment_feedback').attr('src', 'images/tick-active.png');
                            alert("Feedback submitted succesfully!");
                        },5000);
                        
                    },
                    error:function(err){
                        $('#feedback_value').val('');
                        $("#feedback-area").attr('disabled','');
                        $(".overlay").hide();
                        alert(err);
                    }
                });
                $('#feedback_value').css('border-color','');   
            } 

        });
        $('#username').text('Welcome, ' + localStorage.getItem('firstname'));

        $.ajax({
                    url:API_URL + '/my-orders/' + localStorage.getItem('userId'),
                    type:'GET',
                    success:function(res){
                        console.log("res", res);
                        if(res['result'] != undefined && res['result'].length>0){
                            var orders = res['result'];
                            console.log("orders", orders);
                            $('#preloader').hide();
                            var months = {
                                '01':'Jan',
                                '02':'Feb',
                                '03':'Mar',
                                '04':'April',
                                '05':'May',
                                '06':'June',
                                '07':'July',
                                '08':'Aug',
                                '09':'Sept',
                                '10':'Oct',
                                '11':'Nov',
                                '12':'Dec'
                            };
                            var viewObj = {};    
                            for(var row in orders){
                                viewObj = {};
                                var dataSplit = orders[row].lm_ord_date.split('T')[0].split('-');
                                viewObj.jobId = orders[row].lm_ord_id;
                                viewObj.date = orders[row].lm_ord_date;
                                //viewObj.serviceType = orders[row].lm_ord_service_type;
                                viewObj.fromLocation = orders[row].fromlocation;
                                viewObj.toLocation = orders[row].tolocation;
                                //viewObj.desc = orders[row].lm_ord_comments;
                                var timeValue = orders[row].lm_ord_access_time.split('-');
                                var tableData = '<tr>\
                                <td>' +  months[dataSplit[1]] + ' ' +dataSplit[1]+ ', ' +dataSplit[0]+ '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+ orders[row].lm_ord_access_time +'</td>\
                                <td class="redtxt">' + orders[row].lm_ord_service_type + '</td>\
                                <td>'+orders[row].fromlocation+'  to  '+orders[row].tolocation+'</td>\
                                <td>' + orders[row].lm_ord_id + '</td>\
                                <td><button data-service_provider='+orders[row].lm_ord_service_provider+' data-desc='+orders[row].lm_ord_comments.replace(/ /g, "_")+' data-lm_ord_service_type='+orders[row].lm_ord_service_type.replace(/ /g, "_")+' data-ordinfo='+JSON.stringify(viewObj)+' data-time1='+timeValue[0]+' data-time2='+timeValue[1]+'  class="expand">expand » </button></td>\
                                </tr>';
                                if (orders[row].lm_ord_status == 'O'){
                                    $('#ongoing_user_data').append(tableData);
                                }
                                else {
                                    $('#user_data').append(tableData);
                                }
                            }

                            $(".expand").click(function() {  
                                var ordData = $(this).data("ordinfo")
                                 ,  time1 = $(this).data("time1")
                                 ,  lm_ord_service_type = $(this).data("lm_ord_service_type")
                                 ,  desc = $(this).data("desc")
                                 ,  time2 = $(this).data("time2");
                                 service_provider = $(this).data("service_provider");
                                 //alert(service_provider);
                                console.log("ordData", ordData);    
                                 var dataSplitValues = ordData['date'].split('T')[0].split('-');
                                $('#jobId').text('#' + ordData['jobId']);
                                
                               var value =  '<tr>\
                                    <td>'+  months[dataSplitValues[1]] + ' ' +dataSplitValues[1]+ ', ' +dataSplitValues[0]+' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  '+time1+' — '+time2+'</td>\
                                    <td class="redtxt">'+lm_ord_service_type.replace(/_/g, " ")+' </td>\
                                    <td>'+ordData["fromLocation"]+' to '+ordData["toLocation"]+' </td>\
                                    <td>John W. Doe </td>\
                                    <td>'+ordData['jobId']+' </td>\
                                    <td><button>expand » </button></td>\
                                </tr>';
                                $("#jobOverview tr:eq(1)").remove();
                                $('#jobOverview').append(value);
                                $('#JobDescription').text(desc.replace(/_/g, " "));
                                $('#fromLocation').text(ordData['fromLocation']);
                                $('#toLocation').text(ordData['toLocation']);
                                $('#overall_rating').append('<div class="starwrap overall_rating_dy">\
                                <div class="star-rating"><s><s><s><s><s></s></s></s></s></s></div>');
                                $(".pop").fadeIn('slow');
                                
                                $("div.star-rating > s").on("click", function(e) {
                                $(this).closest('div').find('.active').removeClass('active');
                                    $(e.target).parentsUntil("div").addClass('active');
                                    $(e.target).addClass('active');
                                    numStars = $(e.target).parentsUntil("div").length+1;
                                });
                                //$('.job_confirm').css('visibility','visible')
                                $.ajax({
                                    url:API_URL + '/order-status-tracking/' + ordData['jobId'],
                                    type:'GET',
                                    success:function(res){

                                        $('#status-preloader').hide();
                                        if (res.result != undefined && res.result.length>0) {

                                            for(let i in res.result){
                                                switch(res.result[i].lm_ord_status){

                                                    case 'S':
                                                        $('.job_confirm').css('visibility','visible');
                                                        break;
                                                    case 'A':
                                                        $('.job_confirm').css('visibility','visible');
                                                        break;
                                                    case 'D':
                                                        $('.on_the_way').css('visibility','visible');
                                                        $('#on_the_way').text('Declined');
                                                        break;

                                                    case 'O':
                                                        $('.on_the_way').css('visibility','visible');
                                                        break;
                                                    
                                                    case 'G':
                                                        $('.arrived').css('visibility','visible');
                                                        break;
                                                    case 'M':
                                                        $('.relocation_progress').css('visibility','visible');
                                                        break;    
                                                    case 'F':
                                                        $('.finished').css('visibility','visible');
                                                        break;        
                                                        
                                                }
                                            }
                                        }

                                    },
                                    error:function(err){
                                        $('#status-preloader').hide();
                                    }    
                                });

                                $.ajax({
                                    url:API_URL + '/check-for-feedback/' + ordData['jobId'] + '/' + localStorage.getItem('userId'),
                                    type:'GET',
                                    success:function(res){
                                        console.log("resss", res);
                                        if (res.result !=undefined && res.result[0].feedback>0){
                                            isFeedbackGiven = 1;
                                            $('#payment_feedback').attr('src', 'images/tick-active.png');
                                        }
                                        else {
                                            isFeedbackGiven = 0;
                                        }
                                    },
                                    error:function(err){

                                    }
                                });
                            });
                            $(".pop i").click(function() {   
                                $(".pop").fadeOut('fast');
                                $('.job_confirm').css('visibility','hidden');
                                $('.job_confirm').css('visibility','hidden');
                                $('.on_the_way').css('visibility','hidden');
                                $('#on_the_way').text('Declined');
                                $('.on_the_way').css('visibility','hidden');
                                $('.arrived').css('visibility','hidden');
                                $('.relocation_progress').css('visibility','hidden');
                                $('.finished').css('visibility','hidden');
                                $('#payment_feedback').attr('src', 'images/tick.png');
                                $('#feedback_value').css('border-color','');
                                $('#overall_rating').css('color','');
                                $('.overall_rating_dy').remove();
                            });
                        }
                        else if(res['result']!=undefined && res['result'].length == 0){
                            $('#preloader').hide();
                            $('#user_data').append('<p>Rusult not found</p>');
                        }    
                    },
                    error:function(error){
                        $('#preloader').hide();
                    alert(JSON.stringify(error));
                    }   
                });
    });    

</script>

<script>

</script>


</body>
</html>