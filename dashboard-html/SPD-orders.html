<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i,900,900i" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css?family=Gugi" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="css/style.css" />
<link rel="stylesheet" type="text/css" href="css/responsive.css" />
<link rel="stylesheet" type="text/css" href="css/rating.css" />
<title>Love moving | Dashboard</title>
</head>
<body>


<div class="whitehdr">
  <div class="wrap tbpadding">
  	  	 <h1 class="logowrap"><a href="index.html"><img src="images/logo.png" alt="logo"></a></h1>	
         <div class="topbar-rgt">
         	 <div class="profile-area">
         		<a href="#"><span id="firstname">Welcome, Gabriel </span><img src="images/pic-1.jpg" alt="pic-1"></a>
             </div>
             <div class="icons">
             	<a href="0chat.html"><img src="images/icon-chat.png" alt="chat"></a>
             </div>
             <div class="icons">
             	<a href="#"><img src="images/icon-bell.png" alt="bell"></a>
             </div>
             <div class="icons">
             	<a href="#"><img src="images/icon-setting.png" alt="setting"></a>
             </div>
             <div class="profile-area">
                <h4 id="logout" style="cursor: pointer;">Logout</h4>
            </div>
         </div>
   </div>
</div>



<div class="navwrap">
		<div class="wrap">
            <label for="show-menu" class="show-menu">Show Menu</label>
			<input type="checkbox" id="show-menu" role="button">
         	<ul id="menu">
                <li><a href="1SPD.html">Overview </a></li>
                <li><a href="2SPD.html">Profile </a></li>
                <li><a href="SPD-orders.html" class="active">Orders </a></li>
                <li><a href="3SPD.html">Financial </a></li>
                <li><a href="4SPD.html">Training </a></li>
                <li><a href="5SPD.html">Calendar </a></li>
                <li><a href="6SPD.html">Settings </a></li>
            </ul>
         </div>
</div>

<div class="overlay">
        <div id="loading-img"></div>
    </div>
    
    <div class="content-area">
        <div class="wrap content-wrap">
               
               <div class="whbox">
                        <div class="text-hd">
                            <h2><strong>Placed orders </strong></h2>
                        </div>
                        <div class="table-sc-wrap"> 
                            <div class="table-wrap three-cd-table">
                                <table id="user_data">
                                    <tr>
                                        <th>Date </th>
                                        <th>Service Type </th>
                                        <th>Location </th>
                                        <th>Job ID </th>
                                        <th>Action </th>
                                    </tr>
                                </table>
                                <img id="preloader" style="margin-left: 393px;" src="../images/preloader.gif" alt="logo">
                            </div>
                        </div>
               </div>
        </div>
    </div>
    
    <div class="footer-wrap"></div>
     <!-- Modal -->
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" id="close_model" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Overall Rating </h4>
        </div>
        <div class="modal-body">
          <!-- <h3 id="overall_rating" ></h3> -->
          
          <div class="starwrap overall_rating_dy">
                <label id="overall_rating">Rating:</label>
            
          <div class="form-group">
            <label for="comment" id="feedback_label">Feedback:</label>
            <textarea class="form-control" rows="5" id="feedback_value"></textarea>
          </div>
          <div class="form-group">        
           
              <button type="submit" id="feedback" class="btn btn-default btn-xs">Submit</button>
              <img id="preloader_rating" style="" align="center" src="../images/preloader.gif" width="70" height="70" alt="logo">
          </div>
        </div>
        <!-- <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div> -->
      </div>
      
    </div>
  </div>
  

<!-- JavaScript
================================================== -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="../js/custom.js" type="text/javascript"></script>
<script src="../js/conf.js" type="text/javascript"></script>


<script type="text/javascript">

    isServiceProvider();
    
    $(document).ready(function () {
        var numStars = 0;
        $('#preloader_rating').hide();
        
        $('#close_model').click(function(){
            $('.star-rating').remove();
            numStars = 0;
        });

        $('#feedback').click(function(){
            var feedback = $('#feedback_value').val()
              , jobId = $(this).data('rating_order_id')
              , flag = true;
              jobId = jobId.split('-'); 
            // if(isFeedbackGiven == 1){
            //     flag = false;
            //     alert("Feedback and rating has given already...");
            //     return;
            // }
            if(feedback == '') {
                flag = false;
                $('#feedback_value').css('border-color','red');
                $('#feedback_label').css('color','red');
            }
            else {
                $('#feedback_value').css('border-color','');
                $('#feedback_label').css('color','');
            }
            if(numStars == 0){
                flag = false;
                $('#overall_rating').css('color','red');
            }
            else {
                $('#overall_rating').css('color','');
            }
            if(flag){
                $('#preloader_rating').show();
                $("#feedback").attr('disabled','disabled');
                $.ajax({
                    url:API_URL + '/customer-feedback',
                    type:'POST',
                    data:{
                        feedback_note:feedback,
                        orderid:jobId[0],
                        numStars:numStars,
                        service_provider:jobId[1],
                        userId:localStorage.getItem('userId')
                    },
                    success:function(res){
                        $("#feedback").attr('disabled','');
                        $('#feedback_value').val('');
                        setTimeout(function(){
                            $('#preloader_rating').hide();
                            alert("Feedback submitted succesfully!");
                        },5000);
                        
                    },
                    error:function(err){
                        $('#preloader_rating').hide();
                        $('#feedback_value').val('');
                        $("#feedback").attr('disabled','');
                        alert(err);
                    }
                });
                $('#feedback_value').css('border-color','');   
            } 
        });  

        $('#username').text('Welcome, ' + localStorage.getItem('firstname'));

        $.ajax({
                    url:API_URL + '/order-service-provider/' + localStorage.getItem('userId'),
                    type:'GET',
                    success:function(res){
                        console.log("res", res);
                        if(res['result'] != undefined && res['result'].length>0){
                            var orders = res['result'];
                            console.log("orders", orders);
                            $('#preloader').hide();
                            var months = {
                                '01':'Jan',
                                '02':'Feb',
                                '03':'Mar',
                                '04':'April',
                                '05':'May',
                                '06':'June',
                                '07':'July',
                                '08':'Aug',
                                '09':'Sept',
                                '10':'Oct',
                                '11':'Nov',
                                '12':'Dec'
                            };    
                            var orderStatus = '';
                            for(var row in orders){
                                var dataSplit = orders[row].lm_ord_date.split('T')[0].split('-');
                                console.log(orders[row].lm_ord_id);
                                orderStatus = '';
                                switch(orders[row].lm_ord_status){
                                    case 'S':
                                    orderStatus = '<span id="'+orders[row].lm_ord_id +'"><a class="accept" style="cursor:pointer;">Accept</a>&nbsp;&nbsp;&nbsp;<a class="accept" style="cursor:pointer;">Decline</a></span>';
                                    break;
                                    case 'A':
                                    orderStatus = '<span id="'+orders[row].lm_ord_id +'"><a class="accept" style="cursor:pointer;">In-progress</a>&nbsp;&nbsp;&nbsp;<a class="accept" style="cursor:pointer;">Decline</a></span>';
                                    break;
                                    case 'O':
                                    orderStatus = '<span id="'+orders[row].lm_ord_id +'"><a class="accept" style="cursor:pointer;">Delivered?</a>&nbsp;&nbsp;&nbsp;<a class="accept" style="cursor:pointer;">Decline</a></span>';
                                    break;
                                    case 'F':
                                    orderStatus = '<span id="'+orders[row].lm_ord_id +'"><a class="accept" style="cursor:pointer;">Moved</a> / <button data-lm_ord_user_id="'+orders[row].lm_ord_user_id +'" data-rating_order_id="'+orders[row].lm_ord_id +'" class="btn btn-warning btn-xs rating_to_customer">Rating</button>';
                                    break;
                                    case 'D':
                                    orderStatus = '<span id="'+orders[row].lm_ord_id +'"><a class="accept" style="cursor:pointer;">Declined</a> / <button data-lm_ord_user_id="'+orders[row].lm_ord_user_id +'" data-rating_order_id="'+orders[row].lm_ord_id +'" class="btn btn-warning btn-xs rating_to_customer">Rating</button>';
                                    break;
                                }
                                
                                $('#user_data').append('<tr>\
                                <td>' +  months[dataSplit[1]] + ' ' +dataSplit[1]+ ', ' +dataSplit[0]+ '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+ orders[row].lm_ord_access_time +'</td>\
                                <td class="redtxt">' + orders[row].lm_ord_service_type + '</td>\
                                <td>'+orders[row].fromlocation+'  to  '+orders[row].tolocation+'</td>\
                                <td>' + orders[row].lm_ord_id + '</td>\
                                <td>'+orderStatus+'</td>\
                                </tr>');
                            }
                            
                            $('.rating_to_customer').click(function(){
                                var orderid = $(this).data('rating_order_id')
                                  , ord_user_id = $(this).data('lm_ord_user_id');
                                
                                $("#myModal").modal();
                                $('#overall_rating').append('<div class="star-rating"><s><s><s><s><s></s></s></s></s></s></div>');
                                $('#feedback').attr('data-rating_order_id',orderid + '-' + ord_user_id);
                                $("div.star-rating > s").on("click", function(e) {
            $(this).closest('div').find('.active').removeClass('active');
            $(e.target).parentsUntil("div").addClass('active');
            $(e.target).addClass('active');
            numStars = $(e.target).parentsUntil("div").length+1;
            console.log(numStars);
        }); 

                            });

                            $('.accept').click(function(e){
                                var orderId = $(this).closest('span').attr('id');
                                var status = $(this).text();
                                var statusFlag = '';
                                //In-progress
                                if(status == 'Accept'){
                                    statusFlag = 'A';
                                }
                                else if (status == 'Decline'){
                                    statusFlag = 'D';
                                }
                                else if (status == 'In-progress'){
                                    statusFlag = 'O';
                                }
                                else if(status == 'Delivered?'){
                                    statusFlag = 'F';   
                                }
                                if(confirm('Are you confirm to '+status+' this order?')){
                                    $(".overlay").show();
                                    $.ajax({
                                        url:API_URL + '/' + 'accept-decline-order',
                                        type:'POST',
                                        data:{
                                            userid:localStorage.getItem('userId'),
                                            orderid:orderId,
                                            status:statusFlag
                                        },
                                        success:function(res){
                                            console.log("res", res);
                                            $(".overlay").hide();
                                            if(res['result'] != undefined && res['result']['insertId']!='') {
                                                alert('Order '+ status +' successfully!');
                                                setTimeout(function(){
                                                    //location.reload();
                                                },2000);
                                                
                                            }
                                            else {
                                                alert("something went wrong, please try after sometime!")
                                            }
                                        },
                                        error:function(err){
                                            $(".overlay").hide();
                                            alert(err);
                                        }
                                    });
                                }
                                else {

                                }
                            });

                        }
                        else if(res['result']!=undefined && res['result'].length == 0){
                            $('#preloader').hide();
                            $('#user_data').append('<p>Rusult not found</p>');
                        }    
                    },
                    error:function(error){
                        $('#preloader').hide();
                    alert(JSON.stringify(error));
                    }   
                });      
    });    

</script>



</body>
</html>